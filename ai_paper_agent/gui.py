import streamlit as st
import os
import time
import shutil
from pathlib import Path

# å¼•å…¥ä½ çš„æ ¸å¿ƒæ¨¡å—
from src.agent import ResearchAgent
from src.config import (
    DOCS_DIR, RES_DIR, 
    FILE_BASE_INFO, FILE_MEMORY, FILE_FINAL,
    FILE_INNOV_1, FILE_INNOV_2, FILE_INNOV_3
)
from src.prompts import PromptManager

# å¼•å…¥ Streamlit å®˜æ–¹çš„å›è°ƒå¤„ç†å™¨
from langchain_community.callbacks import StreamlitCallbackHandler

# =============================================================================
# 1. è¾…åŠ©å·¥å…·å‡½æ•°
# =============================================================================
def check_milestone(filename):
    """æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨"""
    return (RES_DIR / filename).exists()

def read_file_content(filename):
    """è¯»å–æ–‡ä»¶å†…å®¹"""
    path = RES_DIR / filename
    if path.exists():
        with open(path, 'r', encoding='utf-8') as f:
            return f.read()
    return None

def clean_project_files(scope="partial"):
    """
    æ–‡ä»¶æ¸…ç†å‡½æ•°
    :param scope: "partial" (ä»…é‡ç½®æ€è·¯) / "full" (å½»åº•é‡ç½®)
    """
    files_to_remove = [
        FILE_MEMORY, FILE_INNOV_1, FILE_INNOV_2, FILE_INNOV_3, FILE_FINAL, "total.md"
    ]
    
    if scope == "full":
        files_to_remove.append(FILE_BASE_INFO)
        figures_dir = RES_DIR / "figures"
        if figures_dir.exists():
            try:
                for item in figures_dir.iterdir():
                    if item.is_file(): item.unlink()
            except Exception: pass

    for filename in files_to_remove:
        path = RES_DIR / filename
        if path.exists():
            try:
                os.remove(path)
            except Exception: pass

def merge_final_report():
    """å°†æ‰€æœ‰ Markdown æ–‡ä»¶åˆå¹¶ä¸º total.md"""
    target_files = [FILE_INNOV_1, FILE_INNOV_2, FILE_INNOV_3, FILE_FINAL]
    total_content = ["# Final Integrated Research Proposal\n", "> Auto-generated by AI Research Agent\n", "---\n"]

    for fname in target_files:
        content = read_file_content(fname)
        if content:
            total_content.append(f"\n\n---\n\n") 
            total_content.append(content)

    with open(RES_DIR / "total.md", 'w', encoding='utf-8') as f:
        f.write("".join(total_content))

# =============================================================================
# 2. é¡µé¢é…ç½®ä¸çŠ¶æ€åˆå§‹åŒ–
# =============================================================================
st.set_page_config(page_title="AI Research Agent", page_icon="ğŸ“", layout="wide")

if "agent" not in st.session_state:
    st.session_state.agent = ResearchAgent()

if "messages" not in st.session_state:
    st.session_state.messages = []

# --- æ™ºèƒ½çŠ¶æ€æ¨æ–­é€»è¾‘ ---
if "phase" not in st.session_state:
    file_phase = "init"
    if check_milestone("total.md"): file_phase = "done" 
    elif check_milestone(FILE_FINAL): file_phase = "final" 
    elif check_milestone(FILE_INNOV_3): file_phase = "final"
    elif check_milestone(FILE_INNOV_2): file_phase = "innov3"
    elif check_milestone(FILE_INNOV_1): file_phase = "innov2"
    elif check_milestone(FILE_BASE_INFO): file_phase = "innov1"
    st.session_state.phase = file_phase

# --- çŠ¶æ€è‡ªæ„ˆ (State Transition) ---
# [Fix Bug 2]: ç¡®ä¿ä» Read -> Innov1 çš„è·³è½¬ç»å¯¹ç”Ÿæ•ˆ
state_changed = False
if st.session_state.phase == "read" and check_milestone(FILE_BASE_INFO):
    st.session_state.phase = "innov1"
    state_changed = True
elif st.session_state.phase == "innov1" and check_milestone(FILE_INNOV_1):
    st.session_state.phase = "innov2"
    state_changed = True
elif st.session_state.phase == "innov2" and check_milestone(FILE_INNOV_2):
    st.session_state.phase = "innov3"
    state_changed = True
elif st.session_state.phase == "innov3" and check_milestone(FILE_INNOV_3):
    st.session_state.phase = "final" 
    state_changed = True

if state_changed:
    st.rerun()

# =============================================================================
# 3. æ¨¡æ€å¼¹çª—
# =============================================================================
@st.dialog("ğŸ“„ æ–‡ä»¶é¢„è§ˆ")
def show_file_content(filename, content):
    st.caption(f"Source: res/{filename}")
    st.markdown(content)

# =============================================================================
# 4. ä¾§è¾¹æ 
# =============================================================================
with st.sidebar:
    st.title("ğŸ“ ç§‘ç ”åŠ©æ‰‹æ§åˆ¶å°")
    
    # [Fix Bug 1]: ä¿®å¤ä¸Šä¼ å’Œé€‰æ‹©é€»è¾‘
    with st.expander("ğŸ“‚ è®ºæ–‡ç®¡ç†", expanded=(st.session_state.phase == "init")):
        uploaded_file = st.file_uploader("ä¸Šä¼ æ–°è®ºæ–‡ (PDF)", type=["pdf"])
        if uploaded_file:
            save_path = DOCS_DIR / uploaded_file.name
            with open(save_path, "wb") as f:
                f.write(uploaded_file.getbuffer())
            
            # åªæœ‰å½“è¿™æ˜¯â€œæ–°â€ä¸Šä¼ çš„æ–‡ä»¶æ—¶ï¼Œæ‰è‡ªåŠ¨é€‰ä¸­å¹¶æç¤ºï¼Œé¿å…æ­»å¾ªç¯
            if "last_processed_file" not in st.session_state or st.session_state.last_processed_file != uploaded_file.name:
                st.session_state.last_processed_file = uploaded_file.name
                # ç›´æ¥ä¿®æ”¹ selectbox ç»‘å®šçš„ key å€¼ï¼Œå®ç°è‡ªåŠ¨é€‰ä¸­
                st.session_state.pdf_selector = uploaded_file.name
                st.toast(f"å·²ä¸Šä¼ å¹¶é€‰ä¸­: {uploaded_file.name}")
                # æ³¨æ„ï¼šè¿™é‡Œå»æ‰äº† st.rerun()ï¼Œä¾é  Streamlit çš„è‡ªç„¶åˆ·æ–°æœºåˆ¶

    # è·å–æ–‡ä»¶åˆ—è¡¨
    pdf_files = list(DOCS_DIR.glob("*.pdf"))
    pdf_names = [f.name for f in pdf_files]

    # å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿å½“å‰é€‰ä¸­çš„æ–‡ä»¶è¿˜åœ¨åˆ—è¡¨ä¸­ï¼ˆé˜²æ­¢æ–‡ä»¶è¢«åˆ åæŠ¥é”™ï¼‰
    if "pdf_selector" not in st.session_state:
        st.session_state.pdf_selector = pdf_names[0] if pdf_names else None
    elif st.session_state.pdf_selector not in pdf_names:
        st.session_state.pdf_selector = pdf_names[0] if pdf_names else None

    # æ¸²æŸ“ä¸‹æ‹‰æ¡†ï¼Œç»‘å®š key="pdf_selector"
    selected_pdf = st.selectbox(
        "é€‰æ‹©ç›®æ ‡è®ºæ–‡", pdf_names, 
        key="pdf_selector",
        disabled=(st.session_state.phase != "init")
    )
    
    st.divider()
    
    st.subheader("å½“å‰è¿›åº¦")
    def render_step_status(label, filename, associated_phases):
        col1, col2 = st.columns([0.8, 0.2])
        is_completed = check_milestone(filename)
        is_doing = (st.session_state.phase in associated_phases) and not is_completed
        
        with col1:
            if is_completed: st.markdown(f"âœ… ~~{label}~~")
            elif is_doing: st.markdown(f"**ğŸ”„ :blue[{label}]**")
            else: st.markdown(f"âšª <span style='color:grey'>{label}</span>", unsafe_allow_html=True)
        
        if is_completed:
            with col2:
                if st.button("ğŸ“„", key=f"btn_{filename}", help=f"é¢„è§ˆ {filename}"):
                    content = read_file_content(filename)
                    if content: show_file_content(filename, content)

    render_step_status("Base Info Extraction", FILE_BASE_INFO, ["read"])
    render_step_status("Innovation 1", FILE_INNOV_1, ["innov1"])
    render_step_status("Innovation 2", FILE_INNOV_2, ["innov2"])
    render_step_status("Innovation 3", FILE_INNOV_3, ["innov3"])
    render_step_status("Final Experiment", FILE_FINAL, ["final"])
    
    if st.session_state.phase == "done":
         st.markdown("âœ… **Total Report Generated**")

    st.divider()
    
    if st.session_state.phase != "done":
        with st.expander("âš ï¸ é‡ç½®é€‰é¡¹ (Reset)", expanded=False):
            if st.button("ğŸ”™ é‡ç½®åˆ›æ–°ç‚¹ (Keep Base)"):
                clean_project_files(scope="partial")
                st.session_state.clear()
                st.rerun()
            if st.button("ğŸ†• å½»åº•é‡ç½® (Change Paper)"):
                clean_project_files(scope="full")
                st.session_state.clear()
                st.rerun()

# =============================================================================
# 5. ä¸»ç•Œé¢é€»è¾‘
# =============================================================================

# --- Phase 4: Done (æœ€ç»ˆå±•ç¤ºé¡µ) ---
if st.session_state.phase == "done":
    st.header("ğŸ† æœ€ç»ˆç§‘ç ”æ–¹æ¡ˆ (Final Proposal)")
    
    if not check_milestone("total.md"):
        merge_final_report()
        st.toast("å·²åˆå¹¶æ‰€æœ‰æ–‡æ¡£ï¼")
    
    col1, col2, col3 = st.columns([0.4, 0.3, 0.3])
    
    content = read_file_content("total.md")
    with col1:
        if content:
            st.download_button(
                "ğŸ“¥ ä¸‹è½½å®Œæ•´æŠ¥å‘Š (MD)", content, "total_research.md",
                type="primary", use_container_width=True
            )
            
    with col2:
        if st.button("ğŸ”„ ä¿ç•™ Base é‡åˆ—åˆ›æ–°ç‚¹", help="ä¿ç•™ base.mdï¼Œåˆ é™¤ innov1/2/3 å’Œ finalï¼Œé‡æ–°å¼€å§‹æ€è€ƒåˆ›æ–°ç‚¹ã€‚", use_container_width=True):
            clean_project_files(scope="partial")
            st.session_state.clear()
            st.rerun()
            
    with col3:
        if st.button("ğŸš€ å¼€å¯æ–°è®ºæ–‡ (Full Reset)", help="åˆ é™¤æ‰€æœ‰æ–‡ä»¶ï¼Œå›åˆ°åˆå§‹çŠ¶æ€ã€‚", use_container_width=True):
            clean_project_files(scope="full")
            st.session_state.clear()
            st.rerun()
            
    st.divider()
    
    if content:
        st.markdown(content)
    else:
        st.error("Error: total.md ç”Ÿæˆå¤±è´¥ã€‚")
        
    st.stop() 

# --- ä»¥ä¸‹æ˜¯äº¤äº’é˜¶æ®µ (Init -> Final) ---

st.header("AI Research Agent: Top-Tier Paper Innovation")

# æ¸²æŸ“å†å²æ¶ˆæ¯
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- Phase 0: Init ---
if st.session_state.phase == "init":
    if not selected_pdf:
        st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ ä¸Šä¼  PDF è®ºæ–‡ã€‚")
    else:
        st.info(f"å°±ç»ªã€‚ç›®æ ‡è®ºæ–‡ï¼š**{selected_pdf}**")
        if st.button("å¼€å§‹é˜…è¯»è®ºæ–‡", type="primary"):
            st.session_state.phase = "read"
            if not (RES_DIR / FILE_MEMORY).exists():
                with open(RES_DIR / FILE_MEMORY, 'w', encoding='utf-8') as f:
                    f.write(PromptManager.get_memory_init_content())
            st.rerun()

# --- Phase 1: Read ---
elif st.session_state.phase == "read":
    if not check_milestone(FILE_BASE_INFO):
        st.session_state.agent.update_phase("read")
        trigger_msg = f"è¯·è¯»å–æ–‡ä»¶ '{selected_pdf}'ï¼Œåˆ†æå…¶æ ¸å¿ƒæ–¹æ³•å’Œç†è®ºï¼Œå¹¶å»ºç«‹ '{FILE_BASE_INFO}'ã€‚"
        
        if not st.session_state.messages or st.session_state.messages[-1]["content"] != trigger_msg:
            st.session_state.messages.append({"role": "user", "content": trigger_msg})
            st.rerun()
        
        if st.session_state.messages[-1]["role"] == "user":
            with st.chat_message("assistant"):
                st_callback = StreamlitCallbackHandler(st.container())
                response_placeholder = st.empty()
                full_response = ""
                try:
                    stream = st.session_state.agent.chat_stream(trigger_msg, callbacks=[st_callback])
                    for chunk in stream:
                        full_response += chunk
                        response_placeholder.markdown(full_response + "â–Œ")
                    response_placeholder.markdown(full_response)
                    st.session_state.messages.append({"role": "assistant", "content": full_response})
                    
                    # ç”ŸæˆæˆåŠŸåï¼Œç«‹åˆ»åˆ·æ–°ï¼Œè§¦å‘ä¸Šæ–¹çš„çŠ¶æ€è‡ªæ„ˆé€»è¾‘è·³è½¬åˆ° innov1
                    st.rerun()
                except Exception as e:
                    st.error(f"Execution Error: {str(e)}")
    else:
        # [Fix Bug 2]: å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ä½†é¡µé¢æœªè·³è½¬ï¼Œè¿™é‡Œå¼ºåˆ¶è·³è½¬
        st.session_state.phase = "innov1"
        st.rerun()

# --- Phase 2: Innovations (1, 2, 3) ---
elif st.session_state.phase in ["innov1", "innov2", "innov3"]:
    phase_map = {"innov1": (FILE_INNOV_1, 1), "innov2": (FILE_INNOV_2, 2), "innov3": (FILE_INNOV_3, 3)}
    current_file, stage_num = phase_map[st.session_state.phase]

    if f"ready_{st.session_state.phase}" not in st.session_state:
        context = {
            "base_summary": read_file_content(FILE_BASE_INFO),
            "memory_log": read_file_content(FILE_MEMORY)
        }
        st.session_state.agent.update_phase(st.session_state.phase, context)
        st.session_state.agent.clear_short_term_memory()
        
        welcome_msg = f"**[Phase 2-{stage_num}]** å·²å°±ç»ªã€‚è¯·æå‡ºå…³äº **åˆ›æ–°ç‚¹ {stage_num}** çš„æ€è·¯ã€‚"
        st.session_state.messages.append({"role": "assistant", "content": welcome_msg})
        st.session_state[f"ready_{st.session_state.phase}"] = True
        st.rerun()

    if prompt := st.chat_input(f"æè¿°åˆ›æ–°ç‚¹ {stage_num} æ€è·¯..."):
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        with st.chat_message("assistant"):
            st_callback = StreamlitCallbackHandler(st.container())
            response_placeholder = st.empty()
            full_response = ""
            
            try:
                stream_generator = st.session_state.agent.chat_stream(prompt, callbacks=[st_callback])
                for chunk in stream_generator:
                    full_response += chunk
                    response_placeholder.markdown(full_response + "â–Œ")
                response_placeholder.markdown(full_response)
                
                st.session_state.messages.append({"role": "assistant", "content": full_response})

                if check_milestone(current_file):
                    st.success(f"ğŸ‰ åˆ›æ–°ç‚¹ {stage_num} å·²å½’æ¡£ï¼")
                    time.sleep(1)
                    st.rerun()
            except Exception as e:
                st.error(f"Error: {e}")

# --- Phase 3: Final Experiment ---
elif st.session_state.phase == "final":
    
    if not check_milestone(FILE_FINAL):
        if "final_triggered" not in st.session_state:
            context = {"base_summary": read_file_content(FILE_BASE_INFO)}
            st.session_state.agent.update_phase("final", context)
            st.session_state.agent.clear_short_term_memory()
            
            trigger = "ä¸‰ä¸ªåˆ›æ–°ç‚¹å·²å°±ç»ªã€‚è¯·è¯»å–æ‰€æœ‰ innov æ–‡ä»¶ï¼Œè®¾è®¡æœ€ç»ˆçš„å¯¹æ¯”å®éªŒå’Œæ¶ˆèå®éªŒæ–¹æ¡ˆï¼Œå¹¶å†™å…¥ final_innov.mdã€‚"
            st.session_state.messages.append({"role": "user", "content": trigger})
            st.session_state["final_triggered"] = True
            st.rerun() 

        if st.session_state.messages[-1]["role"] == "user":
            with st.chat_message("assistant"):
                st_callback = StreamlitCallbackHandler(st.container())
                response_placeholder = st.empty()
                full_response = ""
                
                try:
                    trigger = st.session_state.messages[-1]["content"]
                    stream = st.session_state.agent.chat_stream(trigger, callbacks=[st_callback])
                    for chunk in stream:
                        full_response += chunk
                        response_placeholder.markdown(full_response + "â–Œ")
                    response_placeholder.markdown(full_response)
                    
                    st.session_state.messages.append({"role": "assistant", "content": full_response})
                    
                    if check_milestone(FILE_FINAL):
                        st.rerun() 
                except Exception as e:
                    st.error(f"Execution Error: {str(e)}")
                    del st.session_state["final_triggered"]

    else:
        st.success("âœ… æœ€ç»ˆå®éªŒæ–¹æ¡ˆ (final_innov.md) å·²è®¾è®¡å®Œæˆï¼")
        st.info("Agent å·²ç»¼åˆæ‰€æœ‰åˆ›æ–°ç‚¹å¹¶è®¾è®¡äº†å®éªŒã€‚")
        
        if st.button("ğŸ ç”Ÿæˆæœ€ç»ˆæ±‡æ€»æŠ¥å‘Š (Merge & Finish)", type="primary"):
            merge_final_report() 
            st.session_state.phase = "done"
            st.rerun()