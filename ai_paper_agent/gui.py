import streamlit as st
import os
import time
import shutil
import uuid
from pathlib import Path

# å¼•å…¥æ ¸å¿ƒæ¨¡å—
from src.agent import ResearchAgent
from src.config import (
    DOCS_DIR, RES_DIR, 
    FILE_BASE_INFO, FILE_MEMORY, FILE_FINAL,
    FILE_INNOV_1, FILE_INNOV_2, FILE_INNOV_3
)
from src.prompts import PromptManager

# å¼•å…¥ Streamlit å®˜æ–¹çš„å›è°ƒå¤„ç†å™¨
from langchain_community.callbacks import StreamlitCallbackHandler

# =============================================================================
# 0. é¡µé¢åŸºç¡€é…ç½® (å®Œå…¨ä¿ç•™åŸå§‹æ ·å¼)
# =============================================================================
st.set_page_config(
    page_title="218 Lab | AI Research Agent", 
    page_icon="ğŸ“", 
    layout="wide",
    initial_sidebar_state="expanded"
)

# æ³¨å…¥åŸå§‹é¡¹ç›®çš„æ‰€æœ‰ CSS æ ·å¼ç»†èŠ‚
st.markdown("""
    <style>
    /* å…¨å±€èƒŒæ™¯ä¸å­—ä½“ */
    .main { background-color: #030712; color: #f8fafc; }
    
    /* ä¾§è¾¹æ ç¾åŒ– */
    section[data-testid="stSidebar"] {
        background-color: #111827;
        border-right: 1px solid rgba(255,255,255,0.1);
    }
    
    /* æŒ‰é’®ä¸è¾“å…¥æ¡†å®šåˆ¶ */
    .stButton>button {
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.2s ease;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .stButton>button:hover {
        border-color: #6366f1;
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
    }
    
    /* èŠå¤©æ°”æ³¡æ ·å¼ */
    .stChatMessage {
        background-color: rgba(30, 41, 59, 0.4) !important;
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 16px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* æ­¥éª¤çŠ¶æ€è¡Œç¾åŒ– */
    .status-row {
        display: flex;
        align-items: center;
        padding: 8px 0;
    }
    
    /* è§£å†³è¿›åº¦æ¸²æŸ“æ—¶çš„ React èŠ‚ç‚¹å†²çªï¼šå¼ºåˆ¶é”å®š Column é—´è· */
    [data-testid="stSidebar"] [data-testid="stVerticalBlock"] > div:has(div.stColumn) {
        gap: 0px !important;
    }
    </style>
""", unsafe_allow_html=True)

# =============================================================================
# 1. èº«ä»½è¯†åˆ«ä¸ç‰©ç†è·¯å¾„é”å®š (å®ç°å®ååˆ¶éš”ç¦»)
# =============================================================================
if "user_session_id" not in st.session_state:
    query_params = st.query_params
    url_user = query_params.get("user")
    
    if url_user:
        st.session_state.user_session_id = url_user
    else:
        # å¦‚æœä¸æ˜¯ä»å¯¼èˆªé¡µè·³è½¬ï¼Œé»˜è®¤ä½¿ç”¨ admin
        st.sidebar.warning("âš ï¸ æœªæ£€æµ‹åˆ°ç™»å½•å‡­è¯ï¼Œå½“å‰ä»¥ admin èº«ä»½è¿è¡Œã€‚")
        st.session_state.user_session_id = "admin"

# é”å®šå½“å‰ç”¨æˆ·çš„ç‰©ç†ç›®å½•ï¼šres/{username}
USER_RES_DIR = RES_DIR / st.session_state.user_session_id

# ç¡®ä¿ç”¨æˆ·ä¸“å±ç›®å½•å­˜åœ¨
if not USER_RES_DIR.exists():
    USER_RES_DIR.mkdir(parents=True, exist_ok=True)

# =============================================================================
# 2. æ ¸å¿ƒè¾…åŠ©å·¥å…·å‡½æ•° (å®Œå…¨ä¿ç•™åŸå§‹å¥å£®æ€§)
# =============================================================================
def check_milestone(filename):
    """æ£€æŸ¥ç‰©ç†æ–‡ä»¶æ˜¯å¦å­˜åœ¨"""
    return (USER_RES_DIR / filename).exists()

def read_file_content(filename):
    """è¯»å–æ–‡ä»¶å†…å®¹"""
    path = USER_RES_DIR / filename
    if path.exists():
        with open(path, 'r', encoding='utf-8') as f:
            return f.read()
    return None

def clean_project_files(scope="partial"):
    """
    æ–‡ä»¶æ¸…ç†å‡½æ•°
    :param scope: "partial" (ä»…é‡ç½®æ€è·¯) / "full" (å½»åº•é‡ç½®)
    """
    # éœ€è¦æ¸…ç†çš„æ–‡ä»¶æ¸…å•
    files_to_remove = [
        FILE_MEMORY, FILE_INNOV_1, FILE_INNOV_2, FILE_INNOV_3, FILE_FINAL, "total.md"
    ]
    
    if scope == "full":
        files_to_remove.append(FILE_BASE_INFO)
        # æ¸…ç†è¯¥ç”¨æˆ·ä¸“å±çš„å›¾ç‰‡ç›®å½•
        figures_dir = USER_RES_DIR / "figures"
        if figures_dir.exists():
            try:
                for item in figures_dir.iterdir():
                    if item.is_file(): item.unlink()
            except Exception: pass

    for filename in files_to_remove:
        path = USER_RES_DIR / filename
        if path.exists():
            try:
                os.remove(path)
            except Exception: pass

def merge_final_report():
    """å°†è¯¥ç ”ç©¶å‘˜çš„æ‰€æœ‰æˆæœåˆå¹¶ä¸º total.md"""
    target_files = [FILE_INNOV_1, FILE_INNOV_2, FILE_INNOV_3, FILE_FINAL]
    total_content = [
        "# Final Integrated Research Proposal\n", 
        f"> Generated by 218 Lab AI Agent for Researcher: {st.session_state.user_session_id}\n", 
        "---\n"
    ]

    for fname in target_files:
        content = read_file_content(fname)
        if content:
            total_content.append(f"\n\n---\n\n") 
            total_content.append(content)

    with open(USER_RES_DIR / "total.md", 'w', encoding='utf-8') as f:
        f.write("".join(total_content))

# =============================================================================
# 3. çŠ¶æ€ç®¡ç†ä¸è‡ªåŠ¨æ¨æ–­ (å°Šé‡åŸå§‹é€»è¾‘é“¾)
# =============================================================================

# åˆå§‹åŒ– Agent
if "agent" not in st.session_state:
    st.session_state.agent = ResearchAgent(session_id=st.session_state.user_session_id)

# åˆå§‹åŒ–æ¶ˆæ¯å†å²
if "messages" not in st.session_state:
    st.session_state.messages = []

# --- æ™ºèƒ½çŠ¶æ€æ¨æ–­é€»è¾‘ ---
# æ¯æ¬¡é¡µé¢åˆ·æ–°æ—¶ï¼Œè‡ªåŠ¨æ ¹æ® res/{user} ç›®å½•ä¸‹çš„æ–‡ä»¶ç°çŠ¶åˆ¤æ–­å½“å‰å¤„äºå“ªä¸ª Phase
if "phase" not in st.session_state:
    file_phase = "init"
    if check_milestone("total.md"): file_phase = "done" 
    elif check_milestone(FILE_FINAL): file_phase = "final" 
    elif check_milestone(FILE_INNOV_3): file_phase = "final"
    elif check_milestone(FILE_INNOV_2): file_phase = "innov3"
    elif check_milestone(FILE_INNOV_1): file_phase = "innov2"
    elif check_milestone(FILE_BASE_INFO): file_phase = "innov1"
    st.session_state.phase = file_phase

# --- çŠ¶æ€è‡ªæ„ˆ (State Transition) ---
# å½“åç«¯ç”Ÿæˆæ–‡ä»¶åï¼Œè§¦å‘çŠ¶æ€è‡ªåŠ¨è·³è½¬
state_changed = False
if st.session_state.phase == "read" and check_milestone(FILE_BASE_INFO):
    st.session_state.phase = "innov1"
    state_changed = True
elif st.session_state.phase == "innov1" and check_milestone(FILE_INNOV_1):
    st.session_state.phase = "innov2"
    state_changed = True
elif st.session_state.phase == "innov2" and check_milestone(FILE_INNOV_2):
    st.session_state.phase = "innov3"
    state_changed = True
elif st.session_state.phase == "innov3" and check_milestone(FILE_INNOV_3):
    st.session_state.phase = "final" 
    state_changed = True

if state_changed:
    time.sleep(0.1) # ç¼“å†²ï¼Œé˜²æ­¢ React æ¸²æŸ“å†²çª
    st.rerun()

# =============================================================================
# 4. æ¨¡æ€å¼¹çª— (ç”¨äºæˆæœé¢„è§ˆ)
# =============================================================================
@st.dialog("ğŸ“„ æˆæœæ–‡æ¡£é¢„è§ˆ")
def show_file_content(filename, content):
    st.caption(f"Researcher: {st.session_state.user_session_id} | Path: res/{st.session_state.user_session_id}/{filename}")
    st.markdown(content)

# =============================================================================
# 5. ä¾§è¾¹æ ï¼šæ ¸å¿ƒç®¡ç†ä¸è¿›åº¦ (å½»åº•ä¿®å¤ removeChild æŠ¥é”™çš„å…³é”®åŒºåŸŸ)
# =============================================================================
with st.sidebar:
    st.title("ğŸ“ 218 åŠ©æ‰‹æ§åˆ¶å°")
    st.markdown(f"**å½“å‰ç ”ç©¶å‘˜**: `{st.session_state.user_session_id}`")
    
    st.divider()
    
    # æ–¹æ¡ˆ Aï¼šæ‰‹åŠ¨åŒæ­¥æŒ‰é’® (å¸¦ç¨³å®š Key)
    if st.button("ğŸ”„ åŒæ­¥ä¸ªäººçŸ¥è¯†åº“", key=f"sync_btn_{st.session_state.user_session_id}", use_container_width=True):
        with st.spinner("æ­£åœ¨æ‰«æç¬”è®°å¹¶æ„å»ºå‘é‡ç´¢å¼•..."):
            sync_result = st.session_state.agent.sync_knowledge_base()
            st.toast(sync_result)
            time.sleep(0.5)
            st.rerun()

    # åŸå§‹çš„è®ºæ–‡ç®¡ç†é€»è¾‘
    with st.expander("ğŸ“‚ è®ºæ–‡ç®¡ç†", expanded=(st.session_state.phase == "init")):
        uploaded_file = st.file_uploader("ä¸Šä¼ æ–°è®ºæ–‡ (PDF)", type=["pdf"], key="main_pdf_uploader")
        if uploaded_file:
            save_path = DOCS_DIR / uploaded_file.name
            with open(save_path, "wb") as f:
                f.write(uploaded_file.getbuffer())
            
            # è‡ªåŠ¨é€‰ä¸­ä¸Šä¼ çš„æ–‡ä»¶
            if "last_processed" not in st.session_state or st.session_state.last_processed != uploaded_file.name:
                st.session_state.last_processed = uploaded_file.name
                st.session_state.pdf_selector = uploaded_file.name
                st.toast(f"å·²ä¸Šä¼ å¹¶é€‰ä¸­: {uploaded_file.name}")

    # è·å– PDF åˆ—è¡¨å¹¶åŒæ­¥ Selector
    pdf_files = list(DOCS_DIR.glob("*.pdf"))
    pdf_names = [f.name for f in pdf_files]
    if "pdf_selector" not in st.session_state:
        st.session_state.pdf_selector = pdf_names[0] if pdf_names else None
    
    selected_pdf = st.selectbox(
        "é€‰æ‹©ç›®æ ‡è®ºæ–‡", pdf_names, 
        key="pdf_selector_ui", 
        disabled=(st.session_state.phase != "init")
    )
    
    st.divider()
    st.subheader("å½“å‰ç ”ç©¶è¿›åº¦")

    # ã€æ·±åº¦ä¿®å¤é€»è¾‘ã€‘ï¼šä½¿ç”¨ç¨³å®šå®¹å™¨é”šç‚¹ï¼Œå½»åº•æ ¹é™¤ removeChild é”™è¯¯
    def render_step_status(label, filename, associated_phases):
        # å§‹ç»ˆé€šè¿‡ä¸€ä¸ªç¨³å®šçš„ container é”å®šæ¸²æŸ“ä½ç½®
        row_container = st.container()
        with row_container:
            # æ— è®ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå§‹ç»ˆåˆ›å»º [0.8, 0.2] çš„åˆ—ç»“æ„ï¼Œé˜²æ­¢ React è°ƒæ•´ DOM æ ‘
            col1, col2 = st.columns([0.8, 0.2])
            
            is_completed = check_milestone(filename)
            is_doing = (st.session_state.phase in associated_phases) and not is_completed
            
            with col1:
                # ä½¿ç”¨ st.empty() é¢„ç•™æ§½ä½ï¼Œä¿è¯æ¸²æŸ“æ—¶èŠ‚ç‚¹ ID çš„ä¸€è‡´æ€§
                text_slot = st.empty()
                if is_completed:
                    text_slot.markdown(f"âœ… ~~{label}~~")
                elif is_doing:
                    text_slot.markdown(f"**ğŸ”„ :blue[{label}]**")
                else:
                    text_slot.markdown(f"âšª <span style='color:grey'>{label}</span>", unsafe_allow_html=True)
            
            with col2:
                # å³ä½¿æ²¡æœ‰æŒ‰é’®ï¼Œä¹Ÿè¦æ¸²æŸ“ä¸€ä¸ªç©ºçš„å ä½ç¬¦ï¼Œä¿æŒ DOM èŠ‚ç‚¹æ•°æ’å®š
                btn_slot = st.empty()
                if is_completed:
                    # ä½¿ç”¨æå…¶ç¨³å®šçš„å¤åˆ Keyï¼šåŒ…å«ç”¨æˆ·IDã€æ–‡ä»¶åå’Œç¨³å®šåç¼€
                    stable_key = f"view_{st.session_state.user_session_id}_{filename}_stable_v3"
                    if btn_slot.button("ğŸ“„", key=stable_key, help=f"æŸ¥çœ‹ {filename}"):
                        content = read_file_content(filename)
                        if content:
                            show_file_content(filename, content)
                else:
                    btn_slot.write("")

    # ä¾æ¬¡æ¸²æŸ“æ‰€æœ‰æ­¥éª¤
    render_step_status("æå–è®ºæ–‡åŸºç¡€ä¿¡æ¯ (Base)", FILE_BASE_INFO, ["read"])
    render_step_status("åˆ›æ–°ç‚¹æ¢ç´¢ 1 (Innov 1)", FILE_INNOV_1, ["innov1"])
    render_step_status("åˆ›æ–°ç‚¹æ¢ç´¢ 2 (Innov 2)", FILE_INNOV_2, ["innov2"])
    render_step_status("åˆ›æ–°ç‚¹æ¢ç´¢ 3 (Innov 3)", FILE_INNOV_3, ["innov3"])
    render_step_status("è®¾è®¡å¯¹æ¯”å®éªŒ (Final)", FILE_FINAL, ["final"])
    
    if st.session_state.phase == "done":
         st.markdown("ğŸ‰ **é˜¶æ®µæ€§ä»»åŠ¡å·²å…¨éƒ¨å®Œæˆ**")

    st.divider()
    
    # åŸå§‹é‡ç½®é€‰é¡¹é€»è¾‘
    if st.session_state.phase != "done":
        with st.expander("âš ï¸ é‡ç½®é€‰é¡¹ (Reset)", expanded=False):
            if st.button("ğŸ”™ é‡ç½®åˆ›æ–°ç‚¹ (ä¿ç•™ Base)", key="reset_partial_btn", use_container_width=True):
                clean_project_files(scope="partial")
                # æ¸…é™¤çŠ¶æ€å¹¶é”å®šç”¨æˆ· ID
                cid = st.session_state.user_session_id
                st.session_state.clear()
                st.session_state.user_session_id = cid
                st.rerun()
            if st.button("ğŸ†• å½»åº•é‡ç½® (æ–°è®ºæ–‡)", key="reset_full_btn", use_container_width=True):
                clean_project_files(scope="full")
                cid = st.session_state.user_session_id
                st.session_state.clear()
                st.session_state.user_session_id = cid
                st.rerun()

# =============================================================================
# 6. ä¸»ç•Œé¢é€»è¾‘ (å°Šé‡åŸå§‹ Phase æ¸²æŸ“é€»è¾‘)
# =============================================================================

# --- Phase: Done (æœ€ç»ˆæˆæœæ±‡æ€»å±•ç¤º) ---
if st.session_state.phase == "done":
    st.header("ğŸ† æœ€ç»ˆç§‘ç ”ææ¡ˆ (Final Proposal)")
    
    if not check_milestone("total.md"):
        merge_final_report()
        st.toast("å·²è‡ªåŠ¨ç”Ÿæˆæ±‡æ€»æŠ¥å‘Šï¼")
    
    col1, col2, col3 = st.columns([0.4, 0.3, 0.3])
    
    content = read_file_content("total.md")
    with col1:
        if content:
            st.download_button(
                "ğŸ“¥ ä¸‹è½½å®Œæ•´æŠ¥å‘Š (MD)", content, f"proposal_{st.session_state.user_session_id}.md",
                type="primary", use_container_width=True, key="download_total_btn"
            )
            
    with col2:
        if st.button("ğŸ”„ é‡æ–°å®¡è§†åˆ›æ–°ç‚¹", help="ä¿ç•™åŸºç¡€åˆ†æï¼Œé‡æ–°æ¨å¯¼åˆ›æ–°ç‚¹ã€‚", use_container_width=True, key="done_re_innov"):
            clean_project_files(scope="partial")
            cid = st.session_state.user_session_id
            st.session_state.clear()
            st.session_state.user_session_id = cid
            st.rerun()
            
    with col3:
        if st.button("ğŸš€ å¼€å§‹æ–°è¯¾é¢˜", help="æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Œå¼€å¯æ–°è®ºæ–‡ç ”ç©¶ã€‚", use_container_width=True, key="done_new_start"):
            clean_project_files(scope="full")
            cid = st.session_state.user_session_id
            st.session_state.clear()
            st.session_state.user_session_id = cid
            st.rerun()
            
    st.divider()
    if content:
        st.markdown(content)
    else:
        st.error("Error: æ— æ³•åŠ è½½ total.md æŠ¥å‘Šå†…å®¹ã€‚")
        
    st.stop() # ç»ˆæ­¢åç»­æ¸²æŸ“

# --- å¸¸è§„äº¤äº’ç•Œé¢ ---

st.header(f"AI Research Agent | ç ”ç©¶å‘˜: {st.session_state.user_session_id}")

# æ¸²æŸ“å¯¹è¯å†å² (ä½¿ç”¨åŸå§‹æ ·å¼)
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- Phase: Init (åˆå§‹çŠ¶æ€) ---
if st.session_state.phase == "init":
    if not selected_pdf:
        st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ ä¸Šä¼ æˆ–é€‰æ‹© PDF è®ºæ–‡ä»¥å¼€å§‹ã€‚")
    else:
        st.success(f"ç›®æ ‡è®ºæ–‡å·²å°±ç»ªï¼š**{selected_pdf}**")
        if st.button("ğŸš€ å¼€å§‹é˜…è¯»å¹¶æå–ä¿¡æ¯", type="primary", key="start_work_btn", use_container_width=True):
            st.session_state.phase = "read"
            # åˆå§‹åŒ–è®°å¿†æ–‡ä»¶
            if not (USER_RES_DIR / FILE_MEMORY).exists():
                with open(USER_RES_DIR / FILE_MEMORY, 'w', encoding='utf-8') as f:
                    f.write(PromptManager.get_memory_init_content())
            st.rerun()

# --- Phase: Read (åŸºç¡€ä¿¡æ¯æå–) ---
elif st.session_state.phase == "read":
    if not check_milestone(FILE_BASE_INFO):
        st.session_state.agent.update_phase("read")
        trigger_msg = f"è¯·è¯»å–æ–‡ä»¶ '{selected_pdf}'ï¼Œæ·±å…¥åˆ†æå…¶æ ¸å¿ƒæ–¹æ³•ã€æ•°å­¦ç†è®ºå’Œå®éªŒè®¾ç½®ï¼Œå¹¶å»ºç«‹ '{FILE_BASE_INFO}'ã€‚"
        
        # è‡ªåŠ¨è§¦å‘ç¬¬ä¸€è½®å¯¹è¯é€»è¾‘
        if not st.session_state.messages or st.session_state.messages[-1]["content"] != trigger_msg:
            st.session_state.messages.append({"role": "user", "content": trigger_msg})
            st.rerun()
        
        if st.session_state.messages[-1]["role"] == "user":
            with st.chat_message("assistant"):
                st_callback = StreamlitCallbackHandler(st.container())
                # ä½¿ç”¨ç©ºä½æ§½ç¨³å®šæ–‡æœ¬æµ
                res_slot = st.empty()
                full_response = ""
                try:
                    stream = st.session_state.agent.chat_stream(trigger_msg, callbacks=[st_callback])
                    for chunk in stream:
                        full_response += chunk
                        res_slot.markdown(full_response + "â–Œ")
                    res_slot.markdown(full_response)
                    st.session_state.messages.append({"role": "assistant", "content": full_response})
                    # å®Œæˆåç”±é¡¶éƒ¨çš„è‡ªæ„ˆé€»è¾‘å¤„ç†è·³è½¬
                    st.rerun()
                except Exception as e:
                    st.error(f"Execution Error: {str(e)}")
    else:
        st.session_state.phase = "innov1"
        st.rerun()

# --- Phase: Innovations (åˆ›æ–°ç‚¹ 1, 2, 3) ---
elif st.session_state.phase in ["innov1", "innov2", "innov3"]:
    phase_map = {"innov1": (FILE_INNOV_1, 1), "innov2": (FILE_INNOV_2, 2), "innov3": (FILE_INNOV_3, 3)}
    current_file, stage_num = phase_map[st.session_state.phase]

    # åˆå§‹åŒ–å½“å‰åˆ›æ–°é˜¶æ®µçš„å¤§è„‘ä¸Šä¸‹æ–‡
    if f"ready_{st.session_state.phase}" not in st.session_state:
        context = {
            "base_summary": read_file_content(FILE_BASE_INFO),
            "memory_log": read_file_content(FILE_MEMORY)
        }
        st.session_state.agent.update_phase(st.session_state.phase, context)
        st.session_state.agent.clear_short_term_memory()
        
        welcome_text = f"**[é˜¶æ®µ 2-{stage_num}]** å·²å°±ç»ªã€‚æˆ‘ä»¬ç°åœ¨å¼€å§‹æ¨å¯¼ **åˆ›æ–°ç‚¹ {stage_num}**ã€‚æ‚¨å¯ä»¥æä¾›åˆæ­¥çš„æƒ³æ³•ï¼Œæˆ–è€…è®©æˆ‘æ ¹æ®å·²æœ‰ç¬”è®°è¿›è¡Œå‘æ•£ã€‚"
        st.session_state.messages.append({"role": "assistant", "content": welcome_text})
        st.session_state[f"ready_{st.session_state.phase}"] = True
        st.rerun()

    if prompt := st.chat_input(f"æè¿°å…³äºåˆ›æ–°ç‚¹ {stage_num} çš„ç§‘ç ”çµæ„Ÿ..."):
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        with st.chat_message("assistant"):
            st_callback = StreamlitCallbackHandler(st.container())
            res_slot = st.empty()
            full_response = ""
            
            try:
                stream_generator = st.session_state.agent.chat_stream(prompt, callbacks=[st_callback])
                for chunk in stream_generator:
                    full_response += chunk
                    res_slot.markdown(full_response + "â–Œ")
                res_slot.markdown(full_response)
                
                st.session_state.messages.append({"role": "assistant", "content": full_response})

                # å®šç¨¿æ£€æŸ¥ï¼šå¦‚æœ innov æ–‡ä»¶å·²å†™å…¥ï¼Œç”±è‡ªæ„ˆé€»è¾‘è·³è½¬
                if check_milestone(current_file):
                    st.success(f"ğŸ‰ åˆ›æ–°ç‚¹ {stage_num} å·²æˆåŠŸå®šç¨¿å½’æ¡£ã€‚")
                    time.sleep(1)
                    st.rerun()
            except Exception as e:
                st.error(f"Error during stream: {e}")

# --- Phase: Final (å®éªŒæ–¹æ¡ˆè®¾è®¡) ---
elif st.session_state.phase == "final":
    if not check_milestone(FILE_FINAL):
        if "final_triggered" not in st.session_state:
            context = {"base_summary": read_file_content(FILE_BASE_INFO)}
            st.session_state.agent.update_phase("final", context)
            st.session_state.agent.clear_short_term_memory()
            
            trigger = "æ‰€æœ‰åˆ›æ–°ç‚¹å·²é…é½ã€‚è¯·ç»¼åˆæ‰€æœ‰ innov æ–‡ä»¶ï¼Œè®¾è®¡ä¸€å¥—ä¸¥è°¨çš„å¯¹æ¯”å®éªŒã€æ¶ˆèå®éªŒä»¥åŠå¿…è¦çš„æ•°å­¦è¯æ˜ï¼Œå¹¶å†™å…¥ final_innov.mdã€‚"
            st.session_state.messages.append({"role": "user", "content": trigger})
            st.session_state["final_triggered"] = True
            st.rerun() 

        if st.session_state.messages[-1]["role"] == "user":
            with st.chat_message("assistant"):
                st_callback = StreamlitCallbackHandler(st.container())
                res_slot = st.empty()
                full_response = ""
                
                try:
                    trigger_text = st.session_state.messages[-1]["content"]
                    stream = st.session_state.agent.chat_stream(trigger_text, callbacks=[st_callback])
                    for chunk in stream:
                        full_response += chunk
                        res_slot.markdown(full_response + "â–Œ")
                    res_slot.markdown(full_response)
                    
                    st.session_state.messages.append({"role": "assistant", "content": full_response})
                    
                    if check_milestone(FILE_FINAL):
                        st.rerun() 
                except Exception as e:
                    st.error(f"Critical Error: {str(e)}")
                    del st.session_state["final_triggered"]

    else:
        st.success("âœ… å®éªŒè®¾è®¡ (final_innov.md) å·²åœ†æ»¡å®Œæˆã€‚")
        if st.button("ğŸ åˆå¹¶æ‰€æœ‰é˜¶æ®µæˆæœï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š", type="primary", key="final_merge_all_btn", use_container_width=True):
            merge_final_report() 
            st.session_state.phase = "done"
            st.rerun()